<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSWH Platform â€” Smart Solar Water Heater</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â˜€ï¸</text></svg>">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary: #F59E0B;
      --primary-dark: #D97706;
      --primary-light: #FEF3C7;
      --bg: #0F172A;
      --bg-card: #1E293B;
      --bg-card-hover: #334155;
      --text: #F1F5F9;
      --text-muted: #94A3B8;
      --border: #334155;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --info: #3B82F6;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    
    /* Login Screen */
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%); }
    .login-card { background: var(--bg-card); border-radius: 20px; padding: 48px; width: 420px; max-width: 90vw; box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 1px solid var(--border); }
    .login-logo { text-align: center; margin-bottom: 32px; }
    .login-logo .sun { font-size: 48px; margin-bottom: 12px; }
    .login-logo h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary), #FBBF24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-logo p { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
    .form-group input, .form-group select { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; outline: none; transition: border-color 0.2s; }
    .form-group input:focus, .form-group select:focus { border-color: var(--primary); }
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #000; width: 100%; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
    .btn-sm { padding: 6px 14px; font-size: 13px; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    .btn-danger { background: var(--danger); color: #fff; }
    .login-error { color: var(--danger); font-size: 13px; margin-top: 8px; text-align: center; }
    .login-hint { color: var(--text-muted); font-size: 12px; text-align: center; margin-top: 16px; }
    .login-hint code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 11px; }

    /* App Layout */
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s; }
    .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border); }
    .sidebar-header h2 { font-size: 20px; background: linear-gradient(135deg, var(--primary), #FBBF24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sidebar-header .tenant-name { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; color: var(--text-muted); font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { background: rgba(245,158,11,0.05); color: var(--text); }
    .nav-item.active { background: rgba(245,158,11,0.1); color: var(--primary); border-left-color: var(--primary); }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
    .nav-item .badge { margin-left: auto; background: var(--danger); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; }
    .sidebar-footer { padding: 16px 20px; border-top: 1px solid var(--border); }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: #000; }
    .user-name { font-size: 13px; font-weight: 600; }
    .user-role { font-size: 11px; color: var(--text-muted); }
    .logout-btn { margin-top: 12px; width: 100%; padding: 8px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

    /* Main Content */
    .main { flex: 1; margin-left: 260px; }
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 16px 32px; border-bottom: 1px solid var(--border); background: var(--bg-card); position: sticky; top: 0; z-index: 50; }
    .topbar h1 { font-size: 22px; font-weight: 700; }
    .topbar-actions { display: flex; gap: 12px; align-items: center; }
    .content { padding: 24px 32px; }

    /* Cards */
    .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card-header h3 { font-size: 16px; font-weight: 600; }
    .card-body { padding: 20px; }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .kpi-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 20px; transition: all 0.2s; }
    .kpi-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .kpi-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
    .kpi-value { font-size: 32px; font-weight: 700; }
    .kpi-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .kpi-icon { font-size: 24px; float: right; }

    /* Status badges */
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
    .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
    .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge-info { background: rgba(59,130,246,0.15); color: var(--info); }
    .badge-muted { background: rgba(148,163,184,0.15); color: var(--text-muted); }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
    td { padding: 14px 16px; font-size: 14px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: rgba(245,158,11,0.03); }
    tr:last-child td { border-bottom: none; }

    /* Grid layouts */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; }

    /* Map */
    #map-container { height: 500px; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }

    /* Chart container */
    .chart-container { position: relative; height: 300px; }

    /* Device detail */
    .device-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; }
    .device-icon { width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; font-size: 32px; }
    .device-meta { flex: 1; }
    .device-meta h2 { font-size: 24px; font-weight: 700; }
    .device-meta p { color: var(--text-muted); font-size: 14px; }
    .twin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .twin-card { background: var(--bg); border-radius: 8px; padding: 16px; text-align: center; }
    .twin-value { font-size: 28px; font-weight: 700; margin: 8px 0 4px; }
    .twin-label { font-size: 12px; color: var(--text-muted); }
    .twin-icon { font-size: 24px; }

    /* Alert row */
    .alert-severity { width: 4px; border-radius: 2px; }
    .severity-CRITICAL { background: var(--danger); }
    .severity-WARNING { background: var(--warning); }
    .severity-INFO { background: var(--info); }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-muted); }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .main { margin-left: 0; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .content { padding: 16px; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    .hidden { display: none !important; }
    .clickable { cursor: pointer; }
    .clickable:hover { background: var(--bg-card-hover); }
    .back-btn { cursor: pointer; font-size: 14px; color: var(--text-muted); display: inline-flex; align-items: center; gap: 6px; margin-bottom: 16px; }
    .back-btn:hover { color: var(--primary); }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="login-container">
  <div class="login-card">
    <div class="login-logo">
      <div class="sun">â˜€ï¸</div>
      <h1>SSWH Platform</h1>
      <p>Smart Solar Water Heater Management</p>
    </div>
    <form id="login-form">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="login-email" value="tenant.admin@sswh.io" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" value="password123" required>
      </div>
      <button type="submit" class="btn btn-primary">Sign In</button>
      <div id="login-error" class="login-error hidden"></div>
      <div class="login-hint">
        Demo: <code>tenant.admin@sswh.io</code> / <code>password123</code>
      </div>
    </form>
  </div>
</div>

<!-- APP SHELL -->
<div id="app-shell" class="app hidden">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>â˜€ï¸ SSWH</h2>
      <div class="tenant-name" id="tenant-name">Loading...</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-page="dashboard"><span class="icon">ğŸ“Š</span> Dashboard</div>
      <div class="nav-item" data-page="devices"><span class="icon">ğŸ”§</span> Devices</div>
      <div class="nav-item" data-page="map"><span class="icon">ğŸ—ºï¸</span> Map</div>
      <div class="nav-item" data-page="alerts"><span class="icon">ğŸ””</span> Alerts <span class="badge" id="alert-count-badge" style="display:none">0</span></div>
      <div class="nav-item" data-page="sites"><span class="icon">ğŸ“</span> Sites</div>
      <div class="nav-item" data-page="commands"><span class="icon">âš¡</span> Commands</div>
      <div class="nav-item" data-page="ota"><span class="icon">ğŸ“¦</span> OTA Updates</div>
      <div class="nav-item" data-page="sim"><span class="icon">ğŸ“¶</span> SIM Cards</div>
      <div class="nav-item" data-page="analytics"><span class="icon">ğŸ“ˆ</span> Analytics</div>
      <div class="nav-item" data-page="users"><span class="icon">ğŸ‘¥</span> Users</div>
      <div class="nav-item" data-page="audit"><span class="icon">ğŸ“‹</span> Audit Log</div>
      <div class="nav-item" data-page="api-docs"><span class="icon">ğŸ“š</span> API Docs</div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">TA</div>
        <div>
          <div class="user-name" id="user-name">Loading...</div>
          <div class="user-role" id="user-role">Loading...</div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="topbar">
      <h1 id="page-title">Dashboard</h1>
      <div class="topbar-actions">
        <span id="connection-status" class="badge badge-success">â— Connected</span>
      </div>
    </div>
    <div class="content" id="page-content">
      <!-- Dynamic content loaded here -->
    </div>
  </main>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.location.origin + '/api';
let state = {
  token: localStorage.getItem('sswh_token'),
  user: JSON.parse(localStorage.getItem('sswh_user') || 'null'),
  tenantId: localStorage.getItem('sswh_tenantId'),
  tenantName: localStorage.getItem('sswh_tenantName'),
  currentPage: 'dashboard',
  devices: [],
  sites: [],
  alerts: [],
};

// â”€â”€â”€ API HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...opts.headers };
  if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
  if (state.tenantId) headers['x-tenant-id'] = state.tenantId;
  const res = await fetch(API + path, { ...opts, headers });
  if (res.status === 401) { logout(); throw new Error('Unauthorized'); }
  const data = await res.json();
  if (!res.ok) throw new Error(data.error?.message || 'API Error');
  return data;
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const errEl = document.getElementById('login-error');
  errEl.classList.add('hidden');
  try {
    const data = await fetch(API + '/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: document.getElementById('login-email').value,
        password: document.getElementById('login-password').value,
      }),
    }).then(r => r.json());
    if (!data.token) throw new Error(data.error?.message || 'Login failed');
    state.token = data.token;
    state.user = data.user;
    localStorage.setItem('sswh_token', data.token);
    localStorage.setItem('sswh_user', JSON.stringify(data.user));
    // Get tenants
    const tenants = await api('/tenants');
    if (tenants.length > 0) {
      state.tenantId = tenants[0].id;
      state.tenantName = tenants[0].name;
      localStorage.setItem('sswh_tenantId', tenants[0].id);
      localStorage.setItem('sswh_tenantName', tenants[0].name);
    }
    showApp();
  } catch (err) {
    errEl.textContent = err.message;
    errEl.classList.remove('hidden');
  }
});

function logout() {
  state.token = null; state.user = null; state.tenantId = null;
  localStorage.clear();
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('app-shell').classList.add('hidden');
}

function showApp() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app-shell').classList.remove('hidden');
  document.getElementById('user-name').textContent = state.user.name;
  document.getElementById('user-role').textContent = state.user.memberships?.[0]?.role || 'User';
  document.getElementById('user-avatar').textContent = state.user.name.split(' ').map(n=>n[0]).join('').substring(0,2);
  document.getElementById('tenant-name').textContent = state.tenantName || 'Select Tenant';
  navigate('dashboard');
}

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => navigate(item.dataset.page));
});

function navigate(page) {
  state.currentPage = page;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
  document.getElementById('page-title').textContent = pageTitle(page);
  const content = document.getElementById('page-content');
  content.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';
  
  const renderers = {
    dashboard: renderDashboard,
    devices: renderDevices,
    map: renderMap,
    alerts: renderAlerts,
    sites: renderSites,
    commands: renderCommands,
    ota: renderOTA,
    sim: renderSIM,
    analytics: renderAnalytics,
    users: renderUsers,
    audit: renderAudit,
    'api-docs': renderAPIDocs,
  };
  (renderers[page] || renderDashboard)();
}

function pageTitle(page) {
  const titles = { dashboard:'Dashboard', devices:'Devices', map:'Device Map', alerts:'Alerts', sites:'Sites', commands:'Commands', ota:'OTA Updates', sim:'SIM Cards', analytics:'Analytics', users:'Users', audit:'Audit Log', 'api-docs':'API Documentation' };
  return titles[page] || 'Dashboard';
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard() {
  const c = document.getElementById('page-content');
  try {
    const [summary, devicesRes, alertsRes] = await Promise.all([
      api(`/tenants/${state.tenantId}/dashboard/summary`),
      api('/devices'),
      api('/alerts?status=OPEN'),
    ]);
    const devices = devicesRes.devices || devicesRes || [];
    const alerts = alertsRes.events || alertsRes || [];
    state.devices = devices;
    state.alerts = alerts;
    updateAlertBadge(alerts.length);

    const onlineCount = devices.filter(d => d.twin?.derivedState?.isOnline).length;
    const avgHealth = devices.length ? Math.round(devices.reduce((s,d) => s + (d.twin?.derivedState?.healthScore||0), 0) / devices.length) : 0;
    
    c.innerHTML = `
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-icon">ğŸ”§</div><div class="kpi-label">Total Devices</div><div class="kpi-value">${summary.totalDevices || devices.length}</div><div class="kpi-sub">${onlineCount} online now</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸ“</div><div class="kpi-label">Sites</div><div class="kpi-value">${summary.totalSites || 'â€”'}</div><div class="kpi-sub">Across all locations</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸ””</div><div class="kpi-label">Open Alerts</div><div class="kpi-value" style="color:${alerts.length > 0 ? 'var(--danger)' : 'var(--success)'}">${summary.openAlerts || alerts.length}</div><div class="kpi-sub">${alerts.filter(a=>a.severity==='CRITICAL').length} critical</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸ’š</div><div class="kpi-label">Avg Health Score</div><div class="kpi-value" style="color:${avgHealth > 70 ? 'var(--success)' : avgHealth > 40 ? 'var(--warning)' : 'var(--danger)'}">${avgHealth}%</div><div class="kpi-sub">Fleet average</div></div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-header"><h3>Device Fleet Status</h3></div>
          <div class="card-body"><div class="chart-container"><canvas id="fleet-chart"></canvas></div></div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Recent Alerts</h3></div>
          <div class="card-body">
            ${alerts.length === 0 ? '<div class="empty-state"><div class="icon">âœ…</div><p>No open alerts</p></div>' : 
              `<table><thead><tr><th>Device</th><th>Type</th><th>Severity</th><th>Status</th></tr></thead><tbody>
              ${alerts.slice(0,5).map(a => `<tr><td>${a.device?.name || a.deviceId?.substring(0,8)}</td><td>${a.rule?.type || 'â€”'}</td><td><span class="badge badge-${a.severity==='CRITICAL'?'danger':'warning'}">${a.severity}</span></td><td><span class="badge badge-${a.status==='OPEN'?'danger':a.status==='ACKNOWLEDGED'?'warning':'success'}">${a.status}</span></td></tr>`).join('')}
              </tbody></table>`}
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:24px">
        <div class="card-header"><h3>Device Overview</h3></div>
        <div class="card-body table-container">
          <table><thead><tr><th>Name</th><th>Serial</th><th>Model</th><th>Status</th><th>Online</th><th>Health</th><th>Temp</th></tr></thead><tbody>
          ${devices.map(d => `<tr class="clickable" onclick="showDeviceDetail('${d.id}')">
            <td><strong>${d.name || d.serialNumber}</strong></td>
            <td style="color:var(--text-muted)">${d.serialNumber}</td>
            <td>${d.model}</td>
            <td><span class="badge badge-${d.status==='ACTIVE'?'success':d.status==='INSTALLED'?'info':'muted'}">${d.status}</span></td>
            <td>${d.twin?.derivedState?.isOnline ? '<span class="badge badge-success">â— Online</span>' : '<span class="badge badge-muted">â— Offline</span>'}</td>
            <td>${d.twin?.derivedState?.healthScore != null ? d.twin.derivedState.healthScore + '%' : 'â€”'}</td>
            <td>${d.twin?.derivedState?.lastTankTempC != null ? d.twin.derivedState.lastTankTempC.toFixed(1) + 'Â°C' : 'â€”'}</td>
          </tr>`).join('')}
          </tbody></table>
        </div>
      </div>`;

    // Fleet chart
    const statusCounts = {};
    devices.forEach(d => { statusCounts[d.status] = (statusCounts[d.status]||0) + 1; });
    new Chart(document.getElementById('fleet-chart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#10B981','#3B82F6','#F59E0B','#EF4444','#6B7280'], borderWidth: 0 }],
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94A3B8' } } } },
    });
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ DEVICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDevices() {
  const c = document.getElementById('page-content');
  try {
    const devicesRes = await api('/devices');
    const devices = devicesRes.devices || devicesRes || [];
    state.devices = devices;
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>All Devices (${devices.length})</h3></div>
        <div class="card-body table-container">
          <table><thead><tr><th>Name</th><th>Serial</th><th>Model</th><th>Site</th><th>Status</th><th>Online</th><th>Health</th><th>Firmware</th><th>Last Seen</th></tr></thead><tbody>
          ${devices.map(d => `<tr class="clickable" onclick="showDeviceDetail('${d.id}')">
            <td><strong>${d.name || 'â€”'}</strong></td>
            <td style="color:var(--text-muted);font-family:monospace;font-size:12px">${d.serialNumber}</td>
            <td>${d.model}</td>
            <td>${d.site?.name || 'â€”'}</td>
            <td><span class="badge badge-${d.status==='ACTIVE'?'success':d.status==='INSTALLED'?'info':d.status==='PROVISIONED'?'warning':'muted'}">${d.status}</span></td>
            <td>${d.twin?.derivedState?.isOnline ? '<span class="badge badge-success">â— Online</span>' : '<span class="badge badge-muted">â— Offline</span>'}</td>
            <td>${d.twin?.derivedState?.healthScore != null ? d.twin.derivedState.healthScore + '%' : 'â€”'}</td>
            <td style="font-family:monospace;font-size:12px">${d.firmwareVersion || 'â€”'}</td>
            <td style="color:var(--text-muted);font-size:12px">${d.lastSeenAt ? new Date(d.lastSeenAt).toLocaleString() : 'Never'}</td>
          </tr>`).join('')}
          </tbody></table>
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

async function showDeviceDetail(deviceId) {
  const c = document.getElementById('page-content');
  document.getElementById('page-title').textContent = 'Device Detail';
  c.innerHTML = '<div class="loading"><div class="spinner"></div> Loading device...</div>';
  try {
    const d = await api(`/devices/${deviceId}`);
    const twin = d.twin?.derivedState || {};
    c.innerHTML = `
      <div class="back-btn" onclick="navigate('devices')">â† Back to Devices</div>
      <div class="device-header">
        <div class="device-icon">ğŸŒ¡ï¸</div>
        <div class="device-meta">
          <h2>${d.name || d.serialNumber}</h2>
          <p>${d.model} Â· ${d.serialNumber} Â· FW ${d.firmwareVersion || 'â€”'}</p>
        </div>
        <span class="badge badge-${d.status==='ACTIVE'?'success':d.status==='INSTALLED'?'info':'muted'}" style="font-size:14px;padding:8px 16px">${d.status}</span>
        ${twin.isOnline ? '<span class="badge badge-success" style="font-size:14px;padding:8px 16px">â— Online</span>' : '<span class="badge badge-muted" style="font-size:14px;padding:8px 16px">â— Offline</span>'}
      </div>
      <div class="twin-grid">
        <div class="twin-card"><div class="twin-icon">ğŸŒ¡ï¸</div><div class="twin-value" style="color:${(twin.lastTankTempC||0)>70?'var(--danger)':'var(--primary)'}">${twin.lastTankTempC?.toFixed(1) || 'â€”'}Â°C</div><div class="twin-label">Tank Temperature</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸŒ¤ï¸</div><div class="twin-value">${twin.lastAmbientTempC?.toFixed(1) || 'â€”'}Â°C</div><div class="twin-label">Ambient Temp</div></div>
        <div class="twin-card"><div class="twin-icon">âš¡</div><div class="twin-value">${twin.lastPowerW || 'â€”'}W</div><div class="twin-label">Power</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸ’š</div><div class="twin-value" style="color:${(twin.healthScore||0)>70?'var(--success)':'var(--danger)'}">${twin.healthScore || 'â€”'}%</div><div class="twin-label">Health Score</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸ”¥</div><div class="twin-value">${twin.heaterOn ? '<span style="color:var(--primary)">ON</span>' : '<span style="color:var(--text-muted)">OFF</span>'}</div><div class="twin-label">Heater Status</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸ“¶</div><div class="twin-value">${twin.lastRssi || 'â€”'}</div><div class="twin-label">RSSI (dBm)</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸ”‹</div><div class="twin-value">${twin.last_batteryPct || 'â€”'}%</div><div class="twin-label">Battery</div></div>
        <div class="twin-card"><div class="twin-icon">ğŸ“</div><div class="twin-value" style="font-size:14px">${d.deviceLat?.toFixed(4) || 'â€”'}, ${d.deviceLon?.toFixed(4) || 'â€”'}</div><div class="twin-label">Location</div></div>
      </div>
      <div class="grid-2" style="margin-top:24px">
        <div class="card">
          <div class="card-header"><h3>Device Info</h3></div>
          <div class="card-body">
            <table>
              <tr><td style="color:var(--text-muted)">Site</td><td>${d.site?.name || 'â€”'}</td></tr>
              <tr><td style="color:var(--text-muted)">Owner</td><td>${d.owner?.name || 'â€”'}</td></tr>
              <tr><td style="color:var(--text-muted)">SIM ICCID</td><td style="font-family:monospace">${d.simIccid || 'â€”'}</td></tr>
              <tr><td style="color:var(--text-muted)">Last Seen</td><td>${d.lastSeenAt ? new Date(d.lastSeenAt).toLocaleString() : 'Never'}</td></tr>
              <tr><td style="color:var(--text-muted)">Created</td><td>${new Date(d.createdAt).toLocaleString()}</td></tr>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>Quick Actions</h3></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:12px">
            <button class="btn btn-primary" onclick="sendCommand('${d.id}','REMOTE_BOOST_SET',{enabled:true})">âš¡ Activate Remote Boost</button>
            <button class="btn btn-outline" onclick="sendCommand('${d.id}','REMOTE_BOOST_SET',{enabled:false})">â¸ï¸ Deactivate Remote Boost</button>
            <button class="btn btn-outline" onclick="navigate('commands')">ğŸ“‹ View Commands</button>
          </div>
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

async function sendCommand(deviceId, type, payload) {
  try {
    await api(`/devices/${deviceId}/commands`, { method: 'POST', body: JSON.stringify({ type, payload }) });
    alert('Command sent successfully!');
  } catch (err) { alert('Error: ' + err.message); }
}

// â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderMap() {
  const c = document.getElementById('page-content');
  c.innerHTML = '<div id="map-container"></div>';
  try {
    const markers = await api('/map/devices?bbox=10,30,35,50');
    const map = L.map('map-container').setView([38.5, 23.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);
    markers.forEach(m => {
      const color = m.status === 'ACTIVE' ? '#10B981' : m.status === 'INSTALLED' ? '#3B82F6' : '#6B7280';
      const icon = L.divIcon({
        className: '',
        html: `<div style="width:28px;height:28px;border-radius:50%;background:${color};border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:14px">ğŸŒ¡ï¸</div>`,
        iconSize: [28, 28], iconAnchor: [14, 14],
      });
      L.marker([m.lat, m.lon], { icon }).addTo(map)
        .bindPopup(`<b>${m.name || m.serialNumber}</b><br>Status: ${m.status}<br>Model: ${m.model || 'â€”'}`);
    });
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAlerts() {
  const c = document.getElementById('page-content');
  try {
    const alertsRes = await api('/alerts');
    const alerts = alertsRes.events || alertsRes || [];
    state.alerts = alerts;
    updateAlertBadge(alerts.filter(a=>a.status==='OPEN').length);
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>All Alerts (${alerts.length})</h3></div>
        <div class="card-body table-container">
          ${alerts.length === 0 ? '<div class="empty-state"><div class="icon">âœ…</div><p>No alerts</p></div>' :
          `<table><thead><tr><th></th><th>Device</th><th>Rule</th><th>Severity</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>
          ${alerts.map(a => `<tr>
            <td><div class="alert-severity severity-${a.severity}" style="width:4px;height:32px;border-radius:2px"></div></td>
            <td>${a.device?.name || a.deviceId?.substring(0,8) || 'â€”'}</td>
            <td>${a.rule?.name || a.rule?.type || 'â€”'}</td>
            <td><span class="badge badge-${a.severity==='CRITICAL'?'danger':'warning'}">${a.severity}</span></td>
            <td><span class="badge badge-${a.status==='OPEN'?'danger':a.status==='ACKNOWLEDGED'?'warning':'success'}">${a.status}</span></td>
            <td style="font-size:12px;color:var(--text-muted)">${new Date(a.createdAt).toLocaleString()}</td>
            <td>
              ${a.status==='OPEN' ? `<button class="btn btn-sm btn-outline" onclick="ackAlert('${a.id}')">ACK</button>` : ''}
              ${a.status!=='CLOSED' ? `<button class="btn btn-sm btn-outline" onclick="closeAlert('${a.id}')" style="margin-left:4px">Close</button>` : ''}
            </td>
          </tr>`).join('')}
          </tbody></table>`}
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

async function ackAlert(id) { try { await api(`/alerts/${id}/ack`, { method:'POST' }); renderAlerts(); } catch(e) { alert(e.message); } }
async function closeAlert(id) { try { await api(`/alerts/${id}/close`, { method:'POST' }); renderAlerts(); } catch(e) { alert(e.message); } }

function updateAlertBadge(count) {
  const badge = document.getElementById('alert-count-badge');
  if (count > 0) { badge.textContent = count; badge.style.display = ''; } else { badge.style.display = 'none'; }
}

// â”€â”€â”€ SITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSites() {
  const c = document.getElementById('page-content');
  try {
    const sites = await api('/sites');
    state.sites = sites;
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>Sites (${sites.length})</h3></div>
        <div class="card-body table-container">
          <table><thead><tr><th>Name</th><th>City</th><th>Country</th><th>Coordinates</th><th>Location Source</th><th>Locked</th><th>Devices</th></tr></thead><tbody>
          ${sites.map(s => `<tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.city || 'â€”'}</td>
            <td>${s.country || 'â€”'}</td>
            <td style="font-family:monospace;font-size:12px">${s.lat?.toFixed(4) || 'â€”'}, ${s.lon?.toFixed(4) || 'â€”'}</td>
            <td><span class="badge badge-info">${s.locationSource || 'â€”'}</span></td>
            <td>${s.locationLock ? '<span class="badge badge-warning">ğŸ”’ Locked</span>' : '<span class="badge badge-muted">Unlocked</span>'}</td>
            <td>${s._count?.devices || 0}</td>
          </tr>`).join('')}
          </tbody></table>
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ COMMANDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderCommands() {
  const c = document.getElementById('page-content');
  try {
    let devices = state.devices;
    if (!devices || !devices.length) { const r = await api('/devices'); devices = r.devices || r || []; }
    let allCmds = [];
    for (const d of devices.slice(0, 10)) {
      try {
        const cmds = await api(`/devices/${d.id}/commands`);
        cmds.forEach(cmd => { cmd._deviceName = d.name || d.serialNumber; });
        allCmds = allCmds.concat(cmds);
      } catch(e) {}
    }
    allCmds.sort((a,b) => new Date(b.requestedAt) - new Date(a.requestedAt));
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>Commands (${allCmds.length})</h3></div>
        <div class="card-body table-container">
          ${allCmds.length === 0 ? '<div class="empty-state"><div class="icon">âš¡</div><p>No commands yet</p></div>' :
          `<table><thead><tr><th>Device</th><th>Type</th><th>Status</th><th>Requested</th><th>Delivered</th><th>ACK</th></tr></thead><tbody>
          ${allCmds.map(cmd => `<tr>
            <td>${cmd._deviceName}</td>
            <td><span class="badge badge-info">${cmd.type}</span></td>
            <td><span class="badge badge-${cmd.status==='ACKED'?'success':cmd.status==='QUEUED'?'warning':cmd.status==='FAILED'?'danger':'info'}">${cmd.status}</span></td>
            <td style="font-size:12px">${new Date(cmd.requestedAt).toLocaleString()}</td>
            <td style="font-size:12px">${cmd.deliveredAt ? new Date(cmd.deliveredAt).toLocaleString() : 'â€”'}</td>
            <td style="font-size:12px">${cmd.ackAt ? new Date(cmd.ackAt).toLocaleString() : 'â€”'}</td>
          </tr>`).join('')}
          </tbody></table>`}
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ OTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderOTA() {
  const c = document.getElementById('page-content');
  try {
    const [firmware, jobs] = await Promise.all([api('/ota/firmware'), api('/ota/jobs')]);
    c.innerHTML = `
      <div class="grid-2">
        <div class="card">
          <div class="card-header"><h3>Firmware Packages (${firmware.length})</h3></div>
          <div class="card-body table-container">
            ${firmware.length === 0 ? '<div class="empty-state"><p>No firmware packages</p></div>' :
            `<table><thead><tr><th>Version</th><th>Checksum</th><th>Created</th></tr></thead><tbody>
            ${firmware.map(f => `<tr><td><strong>v${f.version}</strong></td><td style="font-family:monospace;font-size:11px">${f.checksum?.substring(0,20) || 'â€”'}</td><td style="font-size:12px">${new Date(f.createdAt).toLocaleDateString()}</td></tr>`).join('')}
            </tbody></table>`}
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h3>OTA Jobs (${jobs.length})</h3></div>
          <div class="card-body table-container">
            ${jobs.length === 0 ? '<div class="empty-state"><p>No OTA jobs</p></div>' :
            `<table><thead><tr><th>Target</th><th>Status</th><th>Scheduled</th></tr></thead><tbody>
            ${jobs.map(j => `<tr><td>${j.device?.name || j.deviceId?.substring(0,8) || 'Group'}</td><td><span class="badge badge-${j.status==='COMPLETED'?'success':j.status==='SCHEDULED'?'info':j.status==='FAILED'?'danger':'warning'}">${j.status}</span></td><td style="font-size:12px">${j.scheduledAt ? new Date(j.scheduledAt).toLocaleString() : 'â€”'}</td></tr>`).join('')}
            </tbody></table>`}
          </div>
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ SIM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSIM() {
  const c = document.getElementById('page-content');
  try {
    const sims = await api('/sim');
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>SIM Cards (${sims.length})</h3></div>
        <div class="card-body table-container">
          ${sims.length === 0 ? '<div class="empty-state"><div class="icon">ğŸ“¶</div><p>No SIM cards</p></div>' :
          `<table><thead><tr><th>ICCID</th><th>Carrier</th><th>Plan</th><th>Status</th><th>Data Usage</th><th>MSISDN</th></tr></thead><tbody>
          ${sims.map(s => `<tr>
            <td style="font-family:monospace;font-size:12px">${s.iccid}</td>
            <td>${s.carrier || 'â€”'}</td>
            <td>${s.planName || 'â€”'}</td>
            <td><span class="badge badge-${s.status==='ACTIVE'?'success':s.status==='SUSPENDED'?'warning':'muted'}">${s.status}</span></td>
            <td>${s.dataUsageMb ? s.dataUsageMb.toFixed(1) + ' MB' : 'â€”'}</td>
            <td style="font-family:monospace;font-size:12px">${s.msisdn || 'â€”'}</td>
          </tr>`).join('')}
          </tbody></table>`}
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAnalytics() {
  const c = document.getElementById('page-content');
  try {
    let devices = state.devices;
    if (!devices || !devices.length) { const r = await api('/devices'); devices = r.devices || r || []; }
    const activeDevice = devices.find(d => d.status === 'ACTIVE') || devices[0];
    if (!activeDevice) { c.innerHTML = '<div class="empty-state"><p>No devices available</p></div>'; return; }
    
    const now = new Date();
    const from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const to = now.toISOString().split('T')[0];
    
    let rollups = [];
    try { rollups = await api(`/devices/${activeDevice.id}/rollups/daily?from=${from}&to=${to}`); } catch(e) {}
    
    c.innerHTML = `
      <div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-icon">âš¡</div><div class="kpi-label">Energy Today</div><div class="kpi-value">${rollups.length > 0 ? (rollups[rollups.length-1]?.energyKwhDay?.toFixed(1) || 'â€”') : 'â€”'} kWh</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸ’§</div><div class="kpi-label">Water Today</div><div class="kpi-value">${rollups.length > 0 ? (rollups[rollups.length-1]?.hotWaterUsageLitersDay?.toFixed(0) || 'â€”') : 'â€”'} L</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸŒ¡ï¸</div><div class="kpi-label">Max Temp Today</div><div class="kpi-value">${rollups.length > 0 ? (rollups[rollups.length-1]?.tankTempMaxC?.toFixed(1) || 'â€”') : 'â€”'}Â°C</div></div>
        <div class="kpi-card"><div class="kpi-icon">ğŸ”¥</div><div class="kpi-label">Heater Runtime</div><div class="kpi-value">${rollups.length > 0 ? (rollups[rollups.length-1]?.heaterOnMinutesDay || 'â€”') : 'â€”'} min</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Weekly Energy & Water â€” ${activeDevice.name || activeDevice.serialNumber}</h3></div>
        <div class="card-body"><div class="chart-container"><canvas id="analytics-chart"></canvas></div></div>
      </div>`;
    
    if (rollups.length > 0) {
      new Chart(document.getElementById('analytics-chart'), {
        type: 'bar',
        data: {
          labels: rollups.map(r => new Date(r.dayDate).toLocaleDateString('en', {weekday:'short',month:'short',day:'numeric'})),
          datasets: [
            { label: 'Energy (kWh)', data: rollups.map(r => r.energyKwhDay), backgroundColor: 'rgba(245,158,11,0.7)', borderRadius: 4 },
            { label: 'Water (L)', data: rollups.map(r => r.hotWaterUsageLitersDay), backgroundColor: 'rgba(59,130,246,0.7)', borderRadius: 4 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color:'#94A3B8' }, grid: { color:'#1E293B' } }, y: { ticks: { color:'#94A3B8' }, grid: { color:'#1E293B' } } }, plugins: { legend: { labels: { color:'#94A3B8' } } } },
      });
    }
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderUsers() {
  const c = document.getElementById('page-content');
  try {
    const users = await api('/users');
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>Team Members (${users.length})</h3></div>
        <div class="card-body table-container">
          <table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th></tr></thead><tbody>
          ${users.map(u => `<tr>
            <td><strong>${u.user?.name || u.name || 'â€”'}</strong></td>
            <td style="color:var(--text-muted)">${u.user?.email || u.email || 'â€”'}</td>
            <td><span class="badge badge-info">${u.role || 'â€”'}</span></td>
            <td><span class="badge badge-${(u.user?.status||u.status)==='ACTIVE'?'success':'muted'}">${u.user?.status || u.status || 'â€”'}</span></td>
          </tr>`).join('')}
          </tbody></table>
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ AUDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAudit() {
  const c = document.getElementById('page-content');
  try {
    const logs = await api('/audit?limit=50');
    c.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>Audit Log (${logs.length} recent)</h3></div>
        <div class="card-body table-container">
          ${logs.length === 0 ? '<div class="empty-state"><p>No audit entries</p></div>' :
          `<table><thead><tr><th>Action</th><th>Entity</th><th>User</th><th>Timestamp</th></tr></thead><tbody>
          ${logs.map(l => `<tr>
            <td><span class="badge badge-info">${l.action}</span></td>
            <td>${l.entityType}${l.entityId ? ' Â· ' + l.entityId.substring(0,8) : ''}</td>
            <td>${l.user?.name || l.userId?.substring(0,8) || 'System'}</td>
            <td style="font-size:12px;color:var(--text-muted)">${new Date(l.createdAt).toLocaleString()}</td>
          </tr>`).join('')}
          </tbody></table>`}
        </div>
      </div>`;
  } catch (err) { c.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><p>${err.message}</p></div>`; }
}

// â”€â”€â”€ API DOCS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAPIDocs() {
  const c = document.getElementById('page-content');
  c.innerHTML = `
    <div class="card" style="height:calc(100vh - 140px)">
      <iframe src="/api/docs" style="width:100%;height:100%;border:none;border-radius:var(--radius)"></iframe>
    </div>`;
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (state.token && state.user) {
  showApp();
} else {
  document.getElementById('login-screen').classList.remove('hidden');
}
</script>
</body>
</html>
